package com.flyingkite.myfiles.media;

import android.content.Context;
import android.media.MediaMetadataRetriever;
import android.net.Uri;
import android.text.TextUtils;
import android.webkit.MimeTypeMap;

public class MediaMetadataRetrieverUtil {
    //private static final Loggable z = new Loggable() {};

    public static String extractMetadataFromUri(Context context, Uri uri, int metadataKey, String exceptionValue) {
        // Performance tracking notes:
        //   0~1ms : new MediaMetadataRetriever();
        //   1~3ms : setDataSource
        //   1~4ms : extractMetadata
        //   0~2ms : release
        MediaMetadataRetriever fetcher = null;
        try {
            fetcher = new MediaMetadataRetriever();
            fetcher.setDataSource(context, uri);
            String answer = fetcher.extractMetadata(metadataKey);
            return answer;
        } catch (RuntimeException e) {
            // IllegalArgumentException for // DRA155018-0001
            // IllegalStateException for // https://fabric.io/cyberlink/android/apps/com.cyberlink.powerdirector.dra140225_01/issues/562a0d9bf5d3a7f76b03baa0
            e.printStackTrace();
            return exceptionValue;
        } finally {
            if (fetcher != null) {
                fetcher.release();
            }
        }
    }

    public static String extractMetadataFromFilepath(String path, int metadataKey, String exceptionValue) {
        // Performance tracking notes:
        //   0~1ms : new MediaMetadataRetriever();
        //   1~3ms : setDataSource
        //   1~4ms : extractMetadata
        //   0~2ms : release
        MediaMetadataRetriever fetcher = null;
        try {
            fetcher = new MediaMetadataRetriever();
            fetcher.setDataSource(path);
            String answer = fetcher.extractMetadata(metadataKey);
            return answer;
        } catch (RuntimeException e) {
            e.printStackTrace();
            // IllegalArgumentException for // DRA155018-0001
            // IllegalStateException for // https://fabric.io/cyberlink/android/apps/com.cyberlink.powerdirector.dra140225_01/issues/562a0d9bf5d3a7f76b03baa0
            return exceptionValue;
        } finally {
            if (fetcher != null) {
                fetcher.release();
            }
        }
    }

    public static long extractMetadataFromFilepath(String path, int metadataKey, long exceptionValue) {
        String s = extractMetadataFromFilepath(path, metadataKey, "");
        long ans = exceptionValue;
        if (!TextUtils.isEmpty(s)) {
            try {
                ans = Long.parseLong(s);
            } catch (NumberFormatException e) {
                e.printStackTrace();
            }
        }
        return ans;
    }

    // FileUtil
    public static String getExtension(String path) {
        // Fail for file : /storage/emulated/0/DCIM/Screenshots/Screenshot_20220312-215519_One UI Home.jpg
        // for the space...
        if (false) {
            return MimeTypeMap.getFileExtensionFromUrl(path);
        }

        if (path == null) {
            return null;
        }
        int dot = path.lastIndexOf('.');
        if (dot >= 0) {
            return path.substring(dot + 1);
        } else {
            return "";
        }
    }

    // http://androidxref.com/4.4.4_r1/xref/libcore/luni/src/main/java/libcore/net/MimeUtils.java
    // https://stackoverflow.com/questions/23385520/android-available-mime-types
    public static boolean isMimeTypeLike(String prefix, String path) {
        if (TextUtils.isEmpty(prefix) || TextUtils.isEmpty(path)) {
            return false;
        }
        String ext = getExtension(path);
        String map = MimeTypeMap.getSingleton().getMimeTypeFromExtension(ext);
        //Log.e("TAG", "isMimeTypeLike: " + map + ", " + prefix + ", ext = " + ext);
        if (map != null) {
            return map.startsWith(prefix);
        }
        return false;
    }
}
